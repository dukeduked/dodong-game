<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>똥피하기 게임</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    height: 100%; width: 100%;
    background: #87cefa;
    touch-action: manipulation; /* 터치 확대 방지 */
    -ms-touch-action: manipulation;
    overscroll-behavior: contain;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
  canvas {
    display: block;
  }
  button {
    position: absolute;
    bottom: 20px;
    width: 70px;
    height: 70px;
    font-size: 36px;
    opacity: 0.8;
    user-select: none;
    border-radius: 12px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    cursor: pointer;
    -webkit-user-select:none;
    -webkit-touch-callout:none;
  }
  #leftBtn {
    left: 40%;
  }
  #rightBtn {
    left: 55%;
  }
</style>
</head>
<body>
<script>
let poopImg, charImg;
let charX, charY, charSize;
let poopX, poopY, poopSize;
let poopSpeed;
let isGameOver = false;
let poopFlyX, poopFlyY, poopFlySize;
let score = 0;

let leftBtn, rightBtn;

function preload() {
  poopImg = loadImage('https://i.imgur.com/2UOZnSj.png');
  charImg = loadImage('https://i.imgur.com/SBusVCC.png');
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  resetGame();
  textAlign(LEFT, TOP);
  textSize(24);
  fill(255);

  // 좌우 버튼 생성 및 스타일링
  leftBtn = createButton('◀');
  leftBtn.id('leftBtn');
  leftBtn.size(70, 70);
  leftBtn.style('font-size', '36px');
  leftBtn.style('opacity', '0.8');
  leftBtn.style('border-radius', '12px');
  leftBtn.style('border', 'none');
  leftBtn.style('background-color', 'rgba(255,255,255,0.7)');
  leftBtn.style('box-shadow', '0 2px 5px rgba(0,0,0,0.3)');
  leftBtn.position(width * 0.4, height - 90);
  leftBtn.touchStarted(() => moveLeft());

  rightBtn = createButton('▶');
  rightBtn.id('rightBtn');
  rightBtn.size(70, 70);
  rightBtn.style('font-size', '36px');
  rightBtn.style('opacity', '0.8');
  rightBtn.style('border-radius', '12px');
  rightBtn.style('border', 'none');
  rightBtn.style('background-color', 'rgba(255,255,255,0.7)');
  rightBtn.style('box-shadow', '0 2px 5px rgba(0,0,0,0.3)');
  rightBtn.position(width * 0.55, height - 90);
  rightBtn.touchStarted(() => moveRight());

  // 터치 확대 막기 (더블탭, 핀치줌)
  let lastTouchEnd = 0;
  document.addEventListener('touchstart', function(event) {
    if (event.touches.length > 1) {
      event.preventDefault(); // 두 손가락 터치 확대 방지
    }
  }, { passive: false });

  document.addEventListener('touchend', function(event) {
    let now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault(); // 더블탭 확대 방지
    }
    lastTouchEnd = now;
  }, false);
}

function resetGame() {
  charSize = 80;
  charX = width / 2;
  charY = height - 30;  // 발 위치 기준 Y 고정 (발 아래로 안 내려감)
  poopSize = 60;
  poopX = random(poopSize / 2, width - poopSize / 2);
  poopY = -poopSize;
  poopSpeed = 5;
  isGameOver = false;
  poopFlyX = null;
  poopFlyY = null;
  poopFlySize = poopSize;
  score = 0;
  loop();
}

function draw() {
  drawWindows98BG();

  if (!isGameOver) {
    // 캐릭터 흰색 틴트 적용하며 이미지 그리기 (발 기준으로 위로 커짐)
    tint(255, 255);
    // charY - charSize : 캐릭터 크기 만큼 위로 올려서 발 기준으로 커지도록
    image(charImg, charX - charSize / 2, charY - charSize, charSize, charSize * (charImg.height / charImg.width));
    noTint();

    image(poopImg, poopX - poopSize / 2, poopY, poopSize, poopSize);

    poopY += poopSpeed;

    let charLeft = charX - charSize / 4;
    let charRight = charX + charSize / 4;

    // 충돌 감지 (똥이 캐릭터 영역에 닿으면 게임 오버)
    if (
      poopY + poopSize / 2 >= charY - charSize / 2 &&
      poopX > charLeft && poopX < charRight
    ) {
      isGameOver = true;
      poopFlyX = poopX;
      poopFlyY = poopY;
      poopFlySize = poopSize;
      noLoop();
      loop();
    } else if (poopY > height) {
      score++;
      poopSpeed *= 1.05;
      // 캐릭터 2배 커지기 (최대 300)
      charSize = min(charSize * 2, 300);
      poopX = random(poopSize / 2, width - poopSize / 2);
      poopY = -poopSize;
    }

    fill(255);
    text('Score: ' + score, 10, 10);
  } else {
    poopFlyY += 40;
    poopFlySize *= 1.3;
    poopFlyX = width / 2;

    background(150, 75, 0, map(poopFlySize, poopSize, width * 3, 0, 150));
    tint(255, 255, 255, 200);
    image(poopImg, poopFlyX - poopFlySize / 2, poopFlyY - poopFlySize / 2, poopFlySize, poopFlySize);
    noTint();

    if (poopFlyY - poopFlySize / 2 > height) {
      background(150, 75, 0);
      fill(255, 0, 0);
      textAlign(CENTER, CENTER);
      textSize(48);
      text('GAME OVER', width / 2, height / 2 - 50);

      fill(255);
      rectMode(CENTER);
      rect(width / 2, height / 2 + 30, 160, 60, 12);
      fill(0);
      textSize(28);
      text('다시하기', width / 2, height / 2 + 30);
      noLoop();
    } else {
      loop();
    }
  }
}

function drawWindows98BG() {
  for (let y = 0; y < height; y++) {
    let inter = map(y, 0, height, 0, 1);
    let c = lerpColor(color(135, 206, 250), color(50, 205, 50), inter);
    stroke(c);
    line(0, y, width, y);
  }
}

function keyPressed() {
  if (!isGameOver) {
    if (keyCode === LEFT_ARROW) {
      moveLeft();
    } else if (keyCode === RIGHT_ARROW) {
      moveRight();
    }
  } else {
    if (keyCode === ENTER) {
      resetGame();
    }
  }
}

function moveLeft() {
  charX -= charSize / 4; // 더 부드럽게 움직임
  // 화면 밖 이동 허용 (버그 컨셉)
}

function moveRight() {
  charX += charSize / 4;
  // 화면 밖 이동 허용
}

function mousePressed() {
  if (isGameOver) {
    let bx = width / 2;
    let by = height / 2 + 30;
    let bw = 160;
    let bh = 60;
    if (
      mouseX > bx - bw / 2 &&
      mouseX < bx + bw / 2 &&
      mouseY > by - bh / 2 &&
      mouseY < by + bh / 2
    ) {
      resetGame();
    }
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  leftBtn.position(width * 0.4, height - 90);
  rightBtn.position(width * 0.55, height - 90);
}
</script>
</body>
</html>

